<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget Spreadsheet</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8fafc;
      margin: 20px;
      color: #333;
    }
    h1, h2 {
      color: #1e293b;
    }
    form {
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f1f5f9;
    }
    button {
      cursor: pointer;
    }
    #loading, #main-content {
      display: none;
    }
    .back-button {
      background-color: #3b82f6;
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="loading">Loading...</div>

  <div id="main-content">
    <a href="index.html" class="back-button">Back to Home</a>
    <h1>Budget Spreadsheet</h1>
    
    <form id="budgetForm">
      <label>
        Paycheck Amount:
        <input type="number" id="paycheckAmount" step="0.01" placeholder="e.g., 2209.22" required>
      </label>
      <label>
        Pay Frequency:
        <select id="payFrequency" required>
          <option value="weekly">Weekly (4 per month)</option>
          <option value="twiceWeek">Twice a week (8 per month)</option>
          <option value="everyOtherWeek">Every other week (2 per month)</option>
          <option value="monthly">Monthly (1 per month)</option>
        </select>
      </label>
      <button type="button" onclick="addExpenseRow()">Add Expense</button>
    </form>
    
    <table id="expenseTable">
      <thead>
        <tr>
          <th>Expense Name</th>
          <th>Total Expense Amount</th>
          <th>Your Portion (%)</th>
          <th>Your Expense (Monthly)</th>
          <th>Your Expense (Per Paycheck)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <h2>Results</h2>
    <p>
      <strong>Your Paycheck:</strong> <span id="calculatedPaycheck">$0.00</span>
    </p>
    <p>
      <strong>Your Monthly Income:</strong> <span id="monthlyIncome">$0.00</span>
    </p>
    <p>
      <strong>Leftover Per Paycheck:</strong> <span id="leftoverPerPaycheck">$0.00</span>
    </p>
  </div>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBfns6UFmWFDKyvLq4W6EWXe1qr1cbNuUY",
      authDomain: "budgettracker-8187e.firebaseapp.com",
      databaseURL: "https://budgettracker-8187e-default-rtdb.firebaseio.com",
      projectId: "budgettracker-8187e",
      storageBucket: "budgettracker-8187e.firebasestorage.app",
      messagingSenderId: "622910803459",
      appId: "1:622910803459:web:9761b015edc7b3f98a4836",
      measurementId: "G-Q9XBRDQL7V"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Sign in anonymously so auth.currentUser is defined
    auth.signInAnonymously().catch(function(error) {
      console.error("Anonymous sign-in failed:", error);
    });

    const expenseTableBody = document.querySelector('#expenseTable tbody');
    
    function addExpenseRow(data = {}) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <input type="text" class="expenseName" placeholder="Expense name" required value="${data.name || ''}">
        </td>
        <td>
          <input type="number" class="totalExpense" step="0.01" placeholder="Total expense" required value="${data.totalExpense || ''}">
        </td>
        <td>
          <input type="number" class="yourPortion" step="0.01" placeholder="Your portion (%)" required value="${data.portion || 100}">
        </td>
        <td class="monthlyExpense">$0.00</td>
        <td class="perPaycheckExpense">$0.00</td>
        <td>
          <button type="button" onclick="removeExpenseRow(this)">Remove</button>
        </td>
      `;
      expenseTableBody.appendChild(row);
      
      row.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => {
          calculateBudget();
          saveBudgetData();
        });
      });
    }
    
    function removeExpenseRow(button) {
      const row = button.closest('tr');
      row.remove();
      calculateBudget();
      saveBudgetData();
    }
    
    function getPayPeriodCount() {
      const frequency = document.getElementById('payFrequency').value;
      switch(frequency) {
        case 'weekly': return 4;
        case 'twiceWeek': return 8;
        case 'everyOtherWeek': return 2;
        case 'monthly': return 1;
        default: return 4;
      }
    }
    
    function calculateBudget() {
      const paycheckAmount = parseFloat(document.getElementById('paycheckAmount').value) || 0;
      const payPeriodCount = getPayPeriodCount();
      
      let totalYourMonthlyExpenses = 0;
      
      const rows = expenseTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const totalExpense = parseFloat(row.querySelector('.totalExpense').value) || 0;
        const yourPortionPercent = parseFloat(row.querySelector('.yourPortion').value) || 0;
        const yourMonthlyExpense = totalExpense * (yourPortionPercent / 100);
        totalYourMonthlyExpenses += yourMonthlyExpense;
        
        const perPaycheckExpense = yourMonthlyExpense / payPeriodCount;
        row.querySelector('.monthlyExpense').textContent = `$${yourMonthlyExpense.toFixed(2)}`;
        row.querySelector('.perPaycheckExpense').textContent = `$${perPaycheckExpense.toFixed(2)}`;
      });
      
      const monthlyIncome = paycheckAmount * payPeriodCount;
      const totalExpensePerPaycheck = totalYourMonthlyExpenses / payPeriodCount;
      const leftoverPerPaycheck = paycheckAmount - totalExpensePerPaycheck;
      
      document.getElementById('calculatedPaycheck').textContent = `$${paycheckAmount.toFixed(2)}`;
      document.getElementById('monthlyIncome').textContent = `$${monthlyIncome.toFixed(2)}`;
      document.getElementById('leftoverPerPaycheck').textContent = `$${leftoverPerPaycheck.toFixed(2)}`;
    }

    function saveBudgetData() {
      const user = auth.currentUser;
      if (!user) return;

      const budgetData = {
        paycheck: {
          amount: document.getElementById('paycheckAmount').value,
          frequency: document.getElementById('payFrequency').value
        },
        expenses: Array.from(expenseTableBody.querySelectorAll('tr')).map(row => ({
          name: row.querySelector('.expenseName').value,
          totalExpense: row.querySelector('.totalExpense').value,
          portion: row.querySelector('.yourPortion').value
        }))
      };

      database.ref(`users/${user.uid}/budget`).set(budgetData);
    }

    function loadBudgetData(userId) {
      return database.ref(`users/${userId}/budget`).once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          if (data) {
            document.getElementById('paycheckAmount').value = data.paycheck?.amount || '';
            document.getElementById('payFrequency').value = data.paycheck?.frequency || 'weekly';
            
            expenseTableBody.innerHTML = '';
            if (data.expenses) {
              data.expenses.forEach(expense => addExpenseRow(expense));
            }
            calculateBudget();
          }
        });
    }

    auth.onAuthStateChanged(function(user) {
      const loadingElement = document.getElementById('loading');
      const mainContent = document.getElementById('main-content');
      
      if (user) {
        loadingElement.style.display = 'block';
        loadBudgetData(user.uid).then(() => {
          loadingElement.style.display = 'none';
          mainContent.style.display = 'block';
        });
      } else {
        window.location.href = 'index.html';
      }
    });

    document.getElementById('paycheckAmount').addEventListener('input', () => {
      calculateBudget();
      saveBudgetData();
    });
    document.getElementById('payFrequency').addEventListener('change', () => {
      calculateBudget();
      saveBudgetData();
    });
  </script>
</body>
</html>